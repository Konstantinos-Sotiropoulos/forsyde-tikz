% pgf/tikz library
% for ForSyDe signals
%
% Author: George Ungureanu, KTH - Royal Institute of Technology, Sweden
% Version: 0.1
% Date: 2014/11/20



% Styles for signal, vector and function tips.
\newcommand{\pgfarrowsextend}[1]{%
  \ifdim \pgflinewidth>2pt 
	\@tempdima=\vectorportsize 
  \else 
	\@tempdima=\signalportsize 
  \fi
  \pgfarrowsleftextend{-#1\@tempdima}
  \pgfarrowsrightextend{#1\@tempdima}
}
\newcommand{\pgfarrowsarrowtip}[1]{%
  \ifdim \pgflinewidth>2pt 
	\@tempdima=\vectorportsize 
  \else 
	\@tempdima=\signalportsize 
  \fi
  \pgfpathmoveto{\pgfpoint{2\@tempdima}{0pt}}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpointorigin}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{-\@tempdima}}
  \pgfusepathqfill
}

\newcommand{\pgfarrowsarrowsquaretip}[1]{%
  \ifdim \pgflinewidth>2pt 
	\@tempdima=\vectorportsize 
  \else 
	\@tempdima=\signalportsize 
  \fi
  \pgfpathmoveto{\pgfpoint{2\@tempdima}{0pt}}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpointorigin}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{-\@tempdima}}
  \pgfusepathqfill
  \pgfpathmoveto{\pgfpoint{4\@tempdima}{-\@tempdima}}
  \pgfpathlineto{\pgfpoint{4\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpoint{2\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpoint{2\@tempdima}{-\@tempdima}}
  \pgfpathclose
  \pgfsetfillcolor{\defaultdrawcolor}
  \pgfusepathqfill
}

\newcommand{\pgfarrowsfullsquaretip}[1]{%
  \ifdim \pgflinewidth>2pt 
	\@tempdima=\vectorportsize 
  \else 
	\@tempdima=\signalportsize 
  \fi
  \pgfpathmoveto{\pgfpoint{\@tempdima}{-\@tempdima}}
  \pgfpathlineto{\pgfpoint{\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{-\@tempdima}}
  \pgfpathlineto{\pgfpoint{\@tempdima}{-\@tempdima}}
  \pgfsetfillcolor{\defaultdrawcolor}
  \pgfusepathqfill
}

\newcommand{\pgfarrowsemptysquaretip}[1]{%
  \pgfsetdash{{1cm}}{0cm} 
  \pgfsetcolor{\defaultdrawcolor}%
  \@tempdima=#1\pgflinewidth%
  \pgfpathmoveto{\pgfpoint{\@tempdima}{-\@tempdima}}
  \pgfpathlineto{\pgfpoint{\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{-\@tempdima}}
  \pgfpathclose
  \pgfsetfillcolor{\defaultfillcolor}
  \pgfusepathqfill
  \pgfpathmoveto{\pgfpoint{\@tempdima}{-\@tempdima}}
  \pgfpathlineto{\pgfpoint{\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{\@tempdima}}
  \pgfpathlineto{\pgfpoint{-\@tempdima}{-\@tempdima}}
  \pgfpathclose
  \pgfsetstrokecolor{\defaultdrawcolor}
  \pgfusepathqstroke
}

\newcommand{\pgfarrowsemptyarrowtip}[1]{%
  \pgfsetdash{{1cm}}{0cm} 
  \pgfsetcolor{\defaultdrawcolor}%
  \@tempdima=#1\pgflinewidth%
  \pgfpathmoveto{\pgfpoint{2\@tempdima}{0pt}}
  \pgfpathlineto{\pgfpoint{0}{\@tempdima}}
  \pgfpathlineto{\pgfpointorigin}
  \pgfpathlineto{\pgfpoint{0}{-\@tempdima}}
  \pgfpathlineto{\pgfpoint{2\@tempdima}{0pt}}
  \pgfpathclose
  \pgfusepathqstroke
}

\pgfarrowsdeclare{signal tip}{signal tip}{\pgfarrowsextend{2}}{\pgfarrowsarrowtip{2}}
\pgfarrowsdeclare{>p}{>p}{\pgfarrowsextend{3}}{\pgfarrowsarrowsquaretip{2}}
\pgfarrowsdeclare{p<}{p<}{\pgfarrowsextend{3}}{\pgfarrowsarrowsquaretip{2}}
\pgfarrowsdeclare{p}{p}{\pgfarrowsextend{0}}{\pgfarrowsfullsquaretip{2}}
\pgfarrowsdeclare{function tip}{function tip}{\pgfarrowsextend{1}}{\pgfarrowsemptyarrowtip{3}}
\pgfarrowsdeclare{fi}{fi}{\pgfarrowsextend{-1.5}}{\pgfarrowsemptysquaretip{3}}


%
% Styles for signal, vector and function paths.
%
\tikzset{
  getsignalmoc/.code={
	\ifnocolor
		\defaultdrawcolor
	\else
	  	\ifthenelse{ \equal{#1}{sy}}{\tikzset{sycolor}}{
	  	\ifthenelse{ \equal{#1}{de}}{\tikzset{decolor}}{
	  	\ifthenelse{ \equal{#1}{ct}}{\tikzset{ctcolor}}{
	  	\ifthenelse{ \equal{#1}{sdf}}{\tikzset{sdfcolor}}{}
	  	}}}
    \fi
  },
  s/.style args  = {#1}{getsignalmoc={#1}, line width=\signalpathlinewidth, >= signal tip, draw},
  v/.style args  = {#1}{getsignalmoc={#1}, line width=\vectorpathlinewidth, >= signal tip, draw},
  f/.style       = {line width=\functionpathlinewidth, >= function tip, dotted, shorten >= 1mm, shorten <= 1mm, draw},
}

%
% Styles for data tokens.
%
\newlength{\xTemp}
\newlength{\inTemp}
\ExplSyntaxOn
\NewDocumentCommand{\tokens}{ >{ \SplitList { - } } m }
 {
  \setlength{\xTemp}{0pt}
  \setlength{\inTemp}{\halftokensize}
  \ProcessList { #1 } { \davs__tokens_rec:n }
 }
\cs_new_protected:Nn \davs__tokens_rec:n
 {
  \davs__tokens_do:n { #1 } 
  
  \pgfmathsetlength{\xTemp}{\xTemp+\tokensize+\tokensize}
 }
\cs_new_protected:Nn \davs__tokens_do:n
 {
	\ifthenelse{ \equal{#1}{scalar}}{
		\draw[fill=\defaultfillcolor, thin] (\xTemp,0) circle [radius=\tokensize];
	}{
  	\ifthenelse{ \equal{#1}{vector}}{
		\draw[fill=\defaultfillcolor, thin] (\xTemp-\tokensize,0) -- (\xTemp,-\tokensize) -- (\xTemp+\tokensize,0) -- (\xTemp,\tokensize) -- cycle ;
	}{
  	\ifthenelse{ \equal{#1}{function}}{
		\draw[fill=\defaultfillcolor, thin ] (\xTemp-\tokensize,-\tokensize) rectangle (\xTemp+\tokensize,\tokensize);
	}{
  	\ifthenelse{ \equal{#1}{scalarAE}}{
		\draw[fill=\defaultfillcolor, thin] (\xTemp,0) circle [radius=\tokensize];
		\pgfsetlinewidth{.5pt} 
		\pgfpathmoveto{\pgfpoint{\xTemp}{-.75\inTemp}}
		\pgfpathlineto{\pgfpoint{\xTemp}{\inTemp}}
		\pgfusepathqstroke
		\pgfpathmoveto{\pgfpoint{\xTemp-\inTemp}{-.75\inTemp}}
		\pgfpathlineto{\pgfpoint{\xTemp+\inTemp}{-.75\inTemp}}
		\pgfusepathqstroke
	}{
	\ifthenelse{ \equal{#1}{vectorAE}}{
		\draw[fill=\defaultfillcolor, thin ] (\xTemp-\tokensize,0) -- (\xTemp,-\tokensize) -- (\xTemp+\tokensize,0) -- (\xTemp,\tokensize) -- cycle;
		\pgfsetlinewidth{.5pt} 
		\pgfpathmoveto{\pgfpoint{\xTemp}{-.75\inTemp}}
		\pgfpathlineto{\pgfpoint{\xTemp}{\inTemp}}
		\pgfusepathqstroke
		\pgfpathmoveto{\pgfpoint{\xTemp-.75\inTemp}{-.75\inTemp}}
		\pgfpathlineto{\pgfpoint{\xTemp+.75\inTemp}{-.75\inTemp}}
		\pgfusepathqstroke
	}{
  	\ifthenelse{ \equal{#1}{functionAE}}{
		\draw[fill=\defaultfillcolor, thin ] (\xTemp-\tokensize,-\tokensize) rectangle (\xTemp+\tokensize,\tokensize);
		\pgfsetlinewidth{.5pt} 
		\pgfpathmoveto{\pgfpoint{\xTemp}{-\inTemp}}
		\pgfpathlineto{\pgfpoint{\xTemp}{\inTemp}}
		\pgfusepathqstroke
		\pgfpathmoveto{\pgfpoint{\xTemp-\inTemp}{-\inTemp}}
		\pgfpathlineto{\pgfpoint{\xTemp+\inTemp}{-\inTemp}}
		\pgfusepathqstroke
	}{}
	}}}}}
 }
\ExplSyntaxOff


%
% Path splines syntax
%
\tikzset{
  token/.style={decoration={name=markings, post length=1pt, pre length=1pt, mark=at position \tokPos with {\tokens{#1}}}, postaction=decorate },
  -|-/.style={ to path={ (\tikztostart) 
	-| ($(\tikztostart)!#1!(\tikztotarget)$) 
	|- (\tikztotarget) 
	\tikztonodes }
  },
  -|-/.default=0.5,
  |-|/.style={to path={ (\tikztostart) 
	|- ($(\tikztostart)!#1!(\tikztotarget)$) 
	-| (\tikztotarget)
    \tikztonodes }
  },
  |-|/.default=0.5,
  -|-|/.style args = {#1}{ to path={ (\tikztostart) 
	-| ($(\tikztostart)!#1!(\tikztotarget)$) 
	|- ([yshift=\pDeviate]\tikztotarget) 
	-| (\tikztotarget) 
	\tikztonodes }
  },
  -|-|/.default=0.5,
  -|-|-/.style args = {#1:#2}{ to path={ (\tikztostart) 
	-| ($(\tikztostart)!#1!(\tikztotarget)$) 
	|- ([yshift=\pDeviate]$(\tikztostart)!#2!(\tikztotarget)$) 
	-| ([yshift=\pDeviate]$(\tikztostart)!#2!(\tikztotarget)$)
	|- (\tikztotarget) 
	\tikztonodes }
  },
  -|-|-/.default=0.3:0.7,
  |-|-|/.style args = {#1:#2}{ to path={ (\tikztostart) 
	|- ($(\tikztostart)!#1!(\tikztotarget)$) 
	-| ([xshift=\pDeviate]$(\tikztostart)!#2!(\tikztotarget)$) 
	|- ([xshift=\pDeviate]$(\tikztostart)!#2!(\tikztotarget)$)
	-| (\tikztotarget) 
	\tikztonodes }
  },
  |-|-|/.default=0.3:0.7,
}

% Finally, edge drawing helpers
\def\signal[#1] (#2) #3 (#4);{
        \draw (#2) edge[#1, #3, s=\MoC,] (#4);
}
\def\vector[#1] (#2) #3 (#4);{
        \draw (#2) edge[#1, #3, v=\MoC,] (#4);
}
\def\function[#1] (#2) #3 (#4);{
        \draw (#2) edge[#1, #3, f,] (#4);
}



\endinput
